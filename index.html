<script>
  let publicaciones = JSON.parse(localStorage.getItem("publicaciones")) || [];
  let logoGuardado = localStorage.getItem("logo");
  let imagenIndex = 0;
  let fotosDetalle = [];
  let editIndex = null; // Nuevo: saber si estamos editando

  if (logoGuardado) document.getElementById("logo").src = logoGuardado;

  function toggleMenu() {
    let menu = document.getElementById("menuCategorias");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  }

  function accederAdmin() {
    let pass = prompt("Ingrese la contraseña:");
    if (pass === "solerolu") {
      document.getElementById("admin").style.display = "block";
      document.querySelector(".contenedor").style.display = "none";
      document.getElementById("detalle").style.display = "none";
      mostrarAdminListado();
    } else {
      alert("Contraseña incorrecta");
    }
  }

  function volverPrincipal() {
    document.getElementById("admin").style.display = "none";
    document.querySelector(".contenedor").style.display = "grid";
    limpiarFormulario();
  }

  function crearPublicacion() {
    const titulo = document.getElementById("titulo").value;
    const descripcion = document.getElementById("descripcion").value;
    const ubicacion = document.getElementById("ubicacion").value;
    const precio = document.getElementById("precio").value + " " + document.getElementById("moneda").value;
    const categoria = document.getElementById("categoria").value;

    const imagenes = [];
    const files = document.getElementById("imagenes").files;

    // Si hay nuevas imágenes
    if (files.length > 0) {
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = () => {
          imagenes.push(reader.result);
          if (imagenes.length === files.length) {
            guardarPublicacion({ titulo, descripcion, ubicacion, precio, categoria, imagenes });
          }
        };
        reader.readAsDataURL(file);
      });
    } else {
      // Si no se subieron nuevas imágenes y estamos editando
      if (editIndex !== null) {
        imagenes.push(...publicaciones[editIndex].imagenes);
        guardarPublicacion({ titulo, descripcion, ubicacion, precio, categoria, imagenes });
      } else {
        alert("Debe subir al menos una imagen");
      }
    }
  }

  function guardarPublicacion(publi) {
    if (editIndex !== null) {
      publicaciones[editIndex] = publi;
      editIndex = null;
    } else {
      publicaciones.push(publi);
    }
    localStorage.setItem("publicaciones", JSON.stringify(publicaciones));
    mostrarPublicaciones(publicaciones);
    mostrarAdminListado();
    limpiarFormulario();
  }

  function mostrarPublicaciones(lista) {
    const contenedor = document.getElementById("publicaciones");
    contenedor.innerHTML = "";
    lista.forEach((p, i) => {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<img src="${p.imagenes[0]}" alt=""><h3>${p.titulo}</h3><p>${p.categoria}</p>`;
      card.onclick = () => abrirDetalle(i);
      contenedor.appendChild(card);
    });
  }

  function abrirDetalle(index) {
    const p = publicaciones[index];
    document.getElementById("detalleTitulo").textContent = p.titulo;
    document.getElementById("detalleDesc").textContent = p.descripcion;
    document.getElementById("detalleUbicacion").textContent = p.ubicacion;
    document.getElementById("detallePrecio").textContent = p.precio;
    fotosDetalle = p.imagenes;
    imagenIndex = 0;
    document.getElementById("detalleImg").src = fotosDetalle[imagenIndex];
    document.getElementById("whatsapp").href =
      `https://wa.me/59161680077?text=Hola, me interesa este inmueble (${p.titulo}), quisiera agendar una cita para verlo por favor.`;
    document.getElementById("detalle").style.display = "flex";
  }

  function cerrarDetalle() {
    document.getElementById("detalle").style.display = "none";
  }

  function cambiarFoto(dir) {
    imagenIndex = (imagenIndex + dir + fotosDetalle.length) % fotosDetalle.length;
    document.getElementById("detalleImg").src = fotosDetalle[imagenIndex];
  }

  function filtrarCategoria(cat) {
    if (cat === "todas") mostrarPublicaciones(publicaciones);
    else mostrarPublicaciones(publicaciones.filter(p => p.categoria === cat));
  }

  function cambiarLogo(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        document.getElementById("logo").src = reader.result;
        localStorage.setItem("logo", reader.result);
      };
      reader.readAsDataURL(file);
    }
  }

  function mostrarAdminListado() {
    const adminListado = document.getElementById("adminListado");
    adminListado.innerHTML = "";
    publicaciones.forEach((p, i) => {
      const div = document.createElement("div");
      div.className = "admin-item";
      div.innerHTML = `
        <div><img src="${p.imagenes[0]}"><strong>${p.titulo}</strong> - ${p.categoria}</div>
        <div class="admin-btns">
          <button onclick="editarPublicacion(${i})">Editar</button>
          <button onclick="eliminarPublicacion(${i})">Eliminar</button>
        </div>`;
      adminListado.appendChild(div);
    });
  }

  function editarPublicacion(index) {
    const p = publicaciones[index];
    document.getElementById("titulo").value = p.titulo;
    document.getElementById("descripcion").value = p.descripcion;
    document.getElementById("ubicacion").value = p.ubicacion;
    document.getElementById("precio").value = parseFloat(p.precio);
    document.getElementById("moneda").value = p.precio.includes("USD") ? "USD" : "BOB";
    document.getElementById("categoria").value = p.categoria;
    editIndex = index;
  }

  function eliminarPublicacion(index) {
    if (confirm("¿Seguro que quieres eliminar esta publicación?")) {
      publicaciones.splice(index, 1);
      localStorage.setItem("publicaciones", JSON.stringify(publicaciones));
      mostrarPublicaciones(publicaciones);
      mostrarAdminListado();
    }
  }

  function limpiarFormulario() {
    document.getElementById("titulo").value = "";
    document.getElementById("descripcion").value = "";
    document.getElementById("ubicacion").value = "";
    document.getElementById("precio").value = "";
    document.getElementById("imagenes").value = "";
    editIndex = null;
  }

  // Rotación de imágenes del hero
  let heroIndex = 0;
  const heroImgs = document.querySelectorAll(".hero img");
  setInterval(() => {
    heroImgs[heroIndex].classList.remove("active");
    heroIndex = (heroIndex + 1) % heroImgs.length;
    heroImgs[heroIndex].classList.add("active");
  }, 3000);

  // Cargar publicaciones guardadas al inicio
  mostrarPublicaciones(publicaciones);
</script>

